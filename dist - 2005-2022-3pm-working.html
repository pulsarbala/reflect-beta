<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Pulsar Bluetooth Remote Access</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
	<link rel="stylesheet" href="css/style-lr2.css">
  <noscript>
    <link rel="stylesheet" href="css/skel-noscript.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/style-desktop.css" />
</noscript>  
  <link rel="stylesheet" href="css/style-lr.css">

  <style>
    .my_text
    {
      /* font-size: 44px; */
  font-family: Arial, sans-serif; 
   /* text-align: center;  */
  /* justify-content: center; */
   /* color: #ffffff; */
        /* font-family:    Arial, Helvetica, sans-serif; */
        font-size:      40px;
        font-weight:    bold;
        /* border: 1px solid #FFFF00; */
        width: 83%;
        padding: 5px 10px;
    }
    /* .center {
      border: 5px solid #FFFF00;
      padding: 50px 0;
    } */
</style>

<script>
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
</script>

<script>
  var inboundChar;
    var outboundChar;
    var device;
    var isIgnore=0;
    var isIgnore_2=0;
    
    // Define the CodeLess UUIDs 
    var CODELESS_SVC_UUID 	= "866d3b04-e674-40dc-9c05-b7f91bec6e83";
    var INBOUND_CHAR_UUID 	= "914f8fb9-e8cd-411d-b7d1-14594de45425";
    var OUTBOUND_CHAR_UUID 	= "3bb535aa-50b2-4fbe-aa09-6b06dc59a404";
    var CNTRL_CHAR_UUID		= "e2048b39-d4f9-4a45-9f25-1856c10d5639";
  
    let options = {
        filters: [
        {name: 'PULS'},
        {name: 'PULS-BT'},
        {name: 'CLv2'},					
        {name: 'ABCa'},
        {name: 'ABC1'},
        {name: 'PMBT'},
		{name: 'ABC1'},
		{name: 'PULSARBT'},
		{name: 'PULSAR-BT'},
		{name: 'CodeLess'},		
        {name: 'Example1'},
        {name: 'Example2'},
        {name: 'Example3'},
        {name: 'Example4'},
        {name: 'Example5'},
        {name: 'Example6'},
        {name: 'Example7'},
        {name: 'Example8'},
        {name: 'Example9'},
        {name: 'CodeLess'},        
        {services: [CODELESS_SVC_UUID]}
        ],
        optionalServices: [CODELESS_SVC_UUID]
    }
  
    // Global variables
    var button_press = 0;
    var isTraceOn = 0;
    var length_var, distance_var, volume_var, compensated_var, mA_output_var, temperature_var, date_var, time_var, gate_start, gate_stop, echo_var, noise_var, status_var, near_blanking_var, far_blanking_var, empty_distance, mode_var, bit0, bit1, bit2, bit3, bit4, bit5, bit6, bit7;
    length_var = 0.000;//4.346;
    distance_var = 0.000;//1.654;
    volume_var = 0.000;//2.370;
    compensated_var = 7.2;
    mA_output_var = 0.000;//20.000;
    temperature_var = 0.000;//20.000;
    date_var = 190100.000;
    time_var = 2210.000;
    gate_start = 0;//202;
    gate_stop = 0;//258;
    echo_var = 0;//45;
    noise_var = 0;//30;
    status_var = 999;
    near_blanking_var = 0.3;
    far_blanking_var = 20.0;//6.0;
    far_blanking_dist = 7.2;
    empty_distance = 6.0;
    mode_var = 6.0;

    // set interval
    var echo_tid;
    var datem_tid;
    var isDisconnecting=0;

    var login_stage = 0;    // Login status


    function echo_start() {
    // do some stuff...
    // no need to recall the function (it's an interval, it'll loop forever)
    if(login_stage == 4) { // TRACE ON state  
        sendAT('GET ECHO');
      //  log("1");
        // alert("sendAT('GET ECHO') : 1");
        button_press = 10;
        datem_tid = setInterval(datem_start, 5000);
        clearTimeout(echo_tid);
    } else {
        clearTimeout(echo_tid);
        clearTimeout(datem_tid);
        }
    }
    function datem_start() {
        if(login_stage == 4) { // TRACE ON state  
            sendAT('GET DATEM');
            button_press = 11;
            echo_tid = setInterval(echo_start, 5000);
            clearTimeout(datem_tid);
        } else {
            clearTimeout(echo_tid);
            clearTimeout(datem_tid);
        }
    }

    function trace_button_check() {
      //log("trace_button_check :"+login_stage);
        if(login_stage == 3 || login_stage == 1 || login_stage == 2 || login_stage == 4) 
        {
          if(isDisconnecting == 0){
              log(' <- TRACE ON');
              sendAT('GET ECHO');
              //log("2");
              document.getElementById("id_trace").click();
              button_press = 10;
              datem_tid = setInterval(datem_start, 5000); 
              login_stage = 4; // TRACE ON state
              isTraceOn=1;
              isIgnore=1;
              isIgnore_2=2;               
          }
        } else {
            log('Device not in passthrough mode!');
        }
    }
    function Normal_mode() {
        sendAT('AT+PT=0');
        clearTimeout(echo_tid);
        clearTimeout(datem_tid);
        log(' <- AT+PT=0');
        login_stage = 3; // back to the PT mode
        // isIgnore=0;
        // isTraceOn=1;
    }

    function trace_off() {  
      //alert("trace_off: isTraceOn="+isTraceOn);
      //alert('trace_off:login_stage='+login_stage+" isTraceOn="+isTraceOn);
      if(isTraceOn==1){
        sendAT('TRACE OFF');
        document.getElementById('btn_trace').innerHTML ='TRACE ON';
        clearTimeout(echo_tid);
        clearTimeout(datem_tid);
        log(' <- TRACE OFF');
        login_stage = 3; // back to the PT mode
        isIgnore=1;
        isTraceOn=0;
      }else{
        // start the static timers - TRACE ON case
        document.getElementById('btn_trace').innerHTML ='TRACE OFF';
        login_stage = 4;
        clearTimeout(echo_tid);
        clearTimeout(datem_tid);
        sendAT('TRACE ON');
        trace_button_check();
        isTraceOn=1;
      } 
    }

    function send_command() {
     // alert("send_command :"+login_stage);
        //if(login_stage >= 1) {
            sendAT(document.getElementById('cmd').value); 
            button_press = 8;
        //}
        //else {
          //  log('No device connected!');
        //}
    }


    const utf8encoder = new TextEncoder();
    const windows1251 = new TextEncoder();
    var deviceName='REFLECT';
    function utf8ToHex(s)
    {
      const rb = utf8encoder.encode(s);
      //const rb = windows1251.encode(s);
      let r = '';
      for (const b of rb) {
        r += ('0' + b.toString(16)).slice(-2);
        r += ' ';
      }
      return r;
    }

    // Function to flip the hex string (if needed)
    function flipHexString(hexValue, hexDigits) {
      var h = hexValue.substr(0, 2);
      for (var i = 0; i < hexDigits; ++i) {
        h += hexValue.substr(2 + (hexDigits - 1 - i) * 2, 2);
      }
      return h;
    }

    // Function to convert Hex values to float (Need Hex string to start with 0x)
    function hexToFloat(hex) {
      var s = hex >> 31 ? -1 : 1;
      var e = (hex >> 23) & 0xFF;
      return (s * (hex & 0x7fffff | 0x800000) * 1.0 / Math.pow(2, 23) * Math.pow(2, (e - 127)));
    }

    // Function to convert unsigned int 8 bit format to hex and relevant functions within it
    function Uint8tohex(s)
    {
      let a = [];     
      var check;
      var floatval;
      const doc_value = document.getElementById('cmd').value;
      for (let i = 0; i < s.byteLength; i++) {
        check = s.getUint8(i);
        if((i >= 46) && (i < 246) && (((doc_value == "GET ECHO") && (button_press == 8)) || (button_press == 10))) // Changed from (i >= 42) && (i < 242)
        {
          echo[i-46] = check*1000/255;  // Changed from echo[i-42]
        }
        else if((i >= 46) && (i < 246) && (((doc_value == "GET DATEM") && (button_press == 8)) || (button_press == 11)))  // Changed from (i >= 42) && (i < 242)
        {
          datem[i-46] = check*1000/255; // Changed from datem[i-42]
        }
        // a.push(s.getUint8(i));
        a.push('0x' + ('00' + s.getUint8(i).toString(16)).slice(-2));
      }
 
      
      if((((doc_value == "GET ECHO") || (doc_value == "GET DATEM") && (button_press == 8)) || (button_press == 10) || (button_press == 11)) && (s.byteLength == 246)) {
        // Populate the dynamic variables
        length_var = hexToFloat('0x' + ('00' + s.getUint8(0).toString(16)).slice(-2) + ('00' + s.getUint8(1).toString(16)).slice(-2) + ('00' + s.getUint8(2).toString(16)).slice(-2) + ('00' + s.getUint8(3).toString(16)).slice(-2));
        distance_var = hexToFloat('0x' + ('00' + s.getUint8(4).toString(16)).slice(-2) + ('00' + s.getUint8(5).toString(16)).slice(-2) + ('00' + s.getUint8(6).toString(16)).slice(-2) + ('00' + s.getUint8(7).toString(16)).slice(-2));
        volume_var = hexToFloat('0x' + ('00' + s.getUint8(8).toString(16)).slice(-2) + ('00' + s.getUint8(9).toString(16)).slice(-2) + ('00' + s.getUint8(10).toString(16)).slice(-2) + ('00' + s.getUint8(11).toString(16)).slice(-2));
        compensated_var = hexToFloat('0x' + ('00' + s.getUint8(12).toString(16)).slice(-2) + ('00' + s.getUint8(13).toString(16)).slice(-2) + ('00' + s.getUint8(14).toString(16)).slice(-2) + ('00' + s.getUint8(15).toString(16)).slice(-2));
        mA_output_var = hexToFloat('0x' + ('00' + s.getUint8(16).toString(16)).slice(-2) + ('00' + s.getUint8(17).toString(16)).slice(-2) + ('00' + s.getUint8(18).toString(16)).slice(-2) + ('00' + s.getUint8(19).toString(16)).slice(-2));
        temperature_var = hexToFloat('0x' + ('00' + s.getUint8(20).toString(16)).slice(-2) + ('00' + s.getUint8(21).toString(16)).slice(-2) + ('00' + s.getUint8(22).toString(16)).slice(-2) + ('00' + s.getUint8(23).toString(16)).slice(-2));
        gate_start = s.getUint8(24)*256 + s.getUint8(25); //s.getUint8(32)*256 + s.getUint8(33);
        gate_stop = s.getUint8(26)*256 + s.getUint8(27);  //s.getUint8(34)*256 + s.getUint8(35);
        echo_var = s.getUint8(28)*256 + s.getUint8(29);   //s.getUint8(36)*256 + s.getUint8(37);
        noise_var = s.getUint8(30)*256 + s.getUint8(31);  //s.getUint8(38)*256 + s.getUint8(39);
        status_var = s.getUint8(32)*256 + s.getUint8(33); //s.getUint8(40)*256 + s.getUint8(41);

        near_blanking_var = hexToFloat('0x' + ('00' + s.getUint8(34).toString(16)).slice(-2) + ('00' + s.getUint8(35).toString(16)).slice(-2) + ('00' + s.getUint8(36).toString(16)).slice(-2) + ('00' + s.getUint8(37).toString(16)).slice(-2)); //hexToFloat('0x' + ('00' + s.getUint8(42).toString(16)).slice(-2) + ('00' + s.getUint8(43).toString(16)).slice(-2) + ('00' + s.getUint8(44).toString(16)).slice(-2) + ('00' + s.getUint8(45).toString(16)).slice(-2));
        far_blanking_var = hexToFloat('0x' + ('00' + s.getUint8(38).toString(16)).slice(-2) + ('00' + s.getUint8(39).toString(16)).slice(-2) + ('00' + s.getUint8(40).toString(16)).slice(-2) + ('00' + s.getUint8(41).toString(16)).slice(-2));  //hexToFloat('0x' + ('00' + s.getUint8(46).toString(16)).slice(-2) + ('00' + s.getUint8(47).toString(16)).slice(-2) + ('00' + s.getUint8(48).toString(16)).slice(-2) + ('00' + s.getUint8(49).toString(16)).slice(-2));  
        empty_distance = hexToFloat('0x' + ('00' + s.getUint8(42).toString(16)).slice(-2) + ('00' + s.getUint8(43).toString(16)).slice(-2) + ('00' + s.getUint8(44).toString(16)).slice(-2) + ('00' + s.getUint8(45).toString(16)).slice(-2));    //hexToFloat('0x' + ('00' + s.getUint8(50).toString(16)).slice(-2) + ('00' + s.getUint8(51).toString(16)).slice(-2) + ('00' + s.getUint8(52).toString(16)).slice(-2) + ('00' + s.getUint8(53).toString(16)).slice(-2));
        if(compensated_var == 24.0)
        {
          mode_var = 20.0;
        }
        else
        {
          mode_var = 8.0;
        }
        far_blanking_dist = empty_distance * (100.0 + far_blanking_var)/100.0;
        var xdata = [];
        xdata[0] = 0.00;
        for (let i = 1; i <= 200; i++)
        {
          xdata[i] = Math.round((xdata[i - 1] + (compensated_var/200))*1000)/1000;
        }
        myChart.data.labels = xdata;      
        myChart.update();
      }
      return a;
    }



    function data_log_update() {
      var status_str='';
      var level_str='';
      var dist_str='';

        var textarea = document.getElementById('data-log');
        textarea.value = "";

        var lvlval = parseFloat(length_var);
        var dstval = parseFloat(distance_var);

        if(parseFloat(length_var) > 0){
          level_str = "Lvl: " + length_var.toFixed(3) + " m" + "\n";
        }

        if(parseFloat(distance_var) > 0){
          dist_str = "Dist: " + distance_var.toFixed(3) + " m" + "\n";
        }

        if (status_var != 999){

              bit0 = status_var & 1;
              bit1 = status_var & 2;
              bit2 = status_var & 4;
              bit3 = status_var & 8;
              bit4 = status_var & 16;
              bit5 = status_var & 32;
              bit6 = status_var & 64;
              bit7 = status_var & 128;
              
              if(status_var == 0)
                status_str = "Status\t\t: OK\n\n";                        
              else {
                  if (bit4 == 16) {
                      if (bit5 == 32)
                          status_str = "Status\t\t: LOE fail high\n\n";
                      else if (bit6 == 64)
                          status_str = "Status\t\t: LOE fail low\n\n";
                      else
                          status_str += "Status\t\t: LOE fail\n\n";
                  }
                  else if (bit3 == 8)
                      status_str= "Status\t\t: LOE\n\n";
                  else if (bit2 == 4)
                      status_str= "Status\t\t: Temp\n\n";
                  else if (bit1 == 2)
                      status_str= "Status\t\t: Voltage\n\n";
                  else if (bit7 == 128)
                      status_str= "Status\t\t: Alarm\n\n";
                  else
                      status_str= "Status\t\t: " + status_var + "\n\n";
              }
              document.getElementById("sensor_status").innerHTML = "<span style='font-sze:12px; color: black; '>"+status_str+"</span>";
              document.getElementById("sensor_status_t").innerHTML = "<span style='font-sze:12px; color: black; '>"+status_str+"</span>";
            }       
        
        document.getElementById("lvl").innerHTML = "<span style='font-sze:12px; color: black; '>"+level_str+"</span>";
        document.getElementById("dist").innerHTML = "<span style='font-sze:12px;color: black;  '>"+dist_str+"</span>";

        textarea.value += "Volume\t= " + volume_var.toFixed(3) + " m³" + "\n";
        textarea.value += "Temp\t= " + temperature_var.toFixed(2) + " °C" + "\n";
        // textarea.value += "Noise\t\t= " + noise_var.toFixed(0) + " mV" + "\n";
        textarea.value += "Output\t= " + mA_output_var.toFixed(2) + " mA";

        // on the trace tab
        document.getElementById("lvl_t").innerHTML = "<span style='font-sze:12px; color: black; '>"+level_str+"</span>";
        document.getElementById("dist_t").innerHTML = "<span style='font-sze:12px;color: black;  '>"+dist_str+"</span>";      
        var textarea1 = document.getElementById('data-log_t');
        textarea1.value = "";
        textarea1.scrollTop = textarea.scrollHeight;
        textarea1.value=textarea.value;
    }


 


// Incoming GATT notification was received
async function incomingData(event){
      // Read data from BLE CodeLess peer
      let readInValue = await outboundChar.readValue();
      let decoder = new TextDecoder('utf-8');
      // var checkBox = document.getElementById("myCheck");
      const doc_value = document.getElementById('cmd').value;
      const string_check =  decoder.decode(readInValue).replace('\r','\r <- ').replace('\n','').replace('\0','');
      //alert("button_press="+button_press+" readInValue="+readInValue+"login_stage="+login_stage+" string_check="+string_check);
      //alert(login_stage + " " +isIgnore);
     // alert(string_check + "1");
     // log("login_stage="+login_stage+" isIgnore="+isIgnore+" isDisconnecting="+isDisconnecting);
      if( (login_stage==3 || login_stage==4 ) && (isIgnore==1) )
      {
         // alert(string_check + "2");
          isIgnore=0;
          // sleep for 2 seconds
          await sleep(2 * 1000);
           return;
      }
      //alert(string_check + "2");
      if ((button_press == 10) || (button_press == 11) || ((button_press == 8) && ((doc_value == "GET ECHO") || (doc_value == "GET DATEM"))))
      {
        var hex = Uint8tohex(readInValue);
        if((button_press == 10) || ((button_press == 8) && (doc_value == "GET ECHO")))
          log(" <- ECHO Received");
        else if ((button_press == 11) || ((button_press == 8) && (doc_value == "GET DATEM")))
          log(" <- DATEM Received");        
      }
      else
      { 
        //alert(string_check + "3");
        if(string_check.includes("Entered PASSTHROUGH mode"))
        {
            login_stage = 3; // Entered PT mode
            log(" <- Log in Success");            
        }
        else if(string_check.includes("Exit PASSTHROUGH mode")){          
          //alert("Exit : isIgnore="+isIgnore+" login_stage="+login_stage+" isDisconnecting="+isDisconnecting+" string_check="+string_check);
          login_stage = 0;
        }
        else if(string_check.includes("Logged In Success") || (string_check.includes("OK")  && login_stage == 1)){
          login_stage = 2;  // Logged in success mode
          closeForm();
          if(isDisconnecting == 0){
            log(" <- Connected");
            sendATL('AT+PT=1');
            //await sleep(3 * 1000);
            setTimeout(trace_button_check, 1000);
          }else {
            await sleep(2 * 1000);
           // alert(isDisconnecting+" ::"+string_check);
            log(" <- disconnecting");
          }
        }
        else if( ( string_check.includes("ERROR") || string_check.includes("Logged In failed")) && login_stage == 1 )
        {
            document.getElementById('lblpsw').innerHTML ='login failed';
            document.getElementById('lblpsw').style.color = "red";
            document.getElementById("pswbox").value='';
            openForm();
        }
        else{
          //log(" ~isIgnore_2= " + isIgnore_2 );
          
          //log("ddddd\n"+string_check+" isDisconnecting= "+isDisconnecting);
          if(isIgnore_2 == 2 || isDisconnecting == 1){
            if(isIgnore_2==2) isIgnore_2=0;
          }else{ 
            log(" <-| " + string_check );
          }
          //log(string_check + " 2" +"isIgnore_2="+isIgnore_2);
            // Log the incoming string (format slightly)
          //var res=decoder.decode(readInValue).replace('\r','\r <- ').replace('\n','').replace('\0','');          
          //log(" <- " + sizeof(res) + " "+res);
          await sleep(2 * 1000);
        }        
      }
    }
  
    async function onDisconnected()
    {
      log("-> Bluetooth connection terminated!");
      button_press=0;
      login_stage = 0;
      isDisconnecting=0; // completed
    }
    
    async function bleTDisconnect()
    {
      if (device.gatt.connected) {
          device.gatt.disconnect();
          log(" -> Disconnected");
      }
      else {
          log('-> Bluetooth Device is already disconnected');
      }
      button_press=0;
      login_stage = 0;
      isDisconnecting=0; // completed
    }

    async function bleT1Disconnect()
    {
      sendATL('AT+PT=0'); //--> BB: commented
      isDisconnecting=1;
      setTimeout(bleTDisconnect,1000);
    }

    async function bleDisconnect()
    {
      if(login_stage == 4){
        sendAT('TRACE OFF');
      }      
      clearTimeout(echo_tid);
      clearTimeout(datem_tid);
      log(" -> Disconnecting");
      setTimeout(bleT1Disconnect,1000);
    }

    // go to the reflect manual page
    async function bleExit1Page(){      
      if(login_stage >0){
        bleDisconnect();
      }
      login_stage=0;
      document.location="https://pulsarmeasurement.com/dbr-radar"
    }

    // go to Pulsar home page  
    async function bleExitPage(){      
      if(login_stage >0){
        bleDisconnect();
      }
      login_stage=0;
      document.location="https://pulsarmeasurement.com"
    }


    async function bleExitPage2(){
      if(login_stage >0){
        bleDisconnect();
        login_stage=0;
      }      
    }

/*
    sendATL commandto be used for only the AT+PT or AT+AUTH
    rest, use the sendAT command
*/
  // Send an AT command to the CodeLess BLE peer
  async function sendATL(cmd) {
    
      if(cmd === 'AT+PT=1'){
          log(' -> Logging ...'   );
          isIgnore=1;
      }
      else if(cmd === 'AT+PT=0'){
        log(' -> Normal mode'   );
        isIgnore=1;
		    return;
      }
      else if(cmd.includes("AT+AUTH="))      
      {
      }
      else 
          log(' -> Connecting ...'   );

// log("\n cmd="+cmd+" isIgnore="+isIgnore+" login_stage="+login_stage+"\n");


      // Append an extra character as expected by CodeLess
      var commandToSend = cmd + "\0";
      try{
        let encoder = new TextEncoder('utf-8');
        // Send command via GATT Write request 
        await inboundChar.writeValue(encoder.encode(commandToSend));
      } 
      catch(error) {
        // if( (isDisconnecting==0 &&  isTraceOn==0 && login_stage==4) ||
        //     (isIgnore==1 && login_stage==3)){ 
        //       log('skip now: ');
        // }else{
          //log(" ~~isIgnore_2= " + isIgnore_2 );
          if(isIgnore_2 == 2){
            isIgnore_2=0;
          }else{
            log('Failed: ' + error);
          }        
      }
    }

      async function ble_connect() {
      
      try {
        // Define a scan filter and prepare for interaction with Codeless Service
          log('');
          log('Requesting Bluetooth Device...');
          device = await navigator.bluetooth.requestDevice(options);
          log('Name: ' + device.name);
          deviceName='REFLECT '+device.name;
          document.getElementById('id_title').innerHTML =deviceName;
  
        device.addEventListener('gattserverdisconnected', onDisconnected);	
        // Connect to device GATT and perform attribute discovery
        server = await device.gatt.connect();
        const service = await server.getPrimaryService(CODELESS_SVC_UUID);
        inboundChar = await service.getCharacteristic(INBOUND_CHAR_UUID);
        outboundChar = await service.getCharacteristic(OUTBOUND_CHAR_UUID);
        const flowcontrolChar = await service.getCharacteristic(CNTRL_CHAR_UUID);
        await flowcontrolChar.startNotifications();
        flowcontrolChar.addEventListener('characteristicvaluechanged', incomingData);
        log('Ready to communicate!\n');
        login_stage = 1;
        // sendATL('AT+AUTH=123321'); //--> BB: commented
        //sendATL('AT+AUTH=123654'); //--> BB: commented
        sendATL('AT+AUTH=000000'); //--> BB: commented
        button_press = 3;
      }
      catch(error) {
        log('Failed: ' + error);
      }
    }


// Send an AT command to the CodeLess BLE peer
async function sendAT(cmd) {
      // Display the command in the log
      log(' -> ' + cmd );
     //  log("\n isIgnore_2=" + isIgnore_2 + " cmd="+cmd);
      // Append an extra character as expected by CodeLess
      var commandToSend = cmd + "\0";
      try{
        let encoder = new TextEncoder('utf-8');
        // Send command via GATT Write request 
        await inboundChar.writeValue(encoder.encode(commandToSend));
      }
      catch(error) {
        log('Failed: ' + error);
      }
    }
    // If enter key was pressed by user while editing, send command immediately
    function wasEnter(elem) {
      if(event.key == 'Enter') {
        button_press = 8;
        sendAT(document.getElementById("cmd").value);
      }
    }

        // Display text in log field text area 
    function log(text)
    {
       // alert(text);
       //isDisconnecting
       /*if(isDisconnecting==0 &&  isTraceOn==1 && login_stage==4) {
       }
       else */
       {
        var textarea = document.getElementById('log');
        if(textarea.value == "")
          textarea.value = text;
        else{
          textarea.value += "\n" + text;	  
          /*textarea.value += "\n"+ "isDisconnecting=" + isDisconnecting;
          textarea.value += "isTraceOn=" + isTraceOn;
          textarea.value += "login_stage=" + login_stage+"\n";*/
          textarea.scrollTop = textarea.scrollHeight;
        }
      }
    }

    // Clears text in log field text area 
    function clearlog()
    {
      var textarea = document.getElementById('log');
      textarea.value = "";	  
      textarea.scrollTop = textarea.scrollHeight;
    }
</script>

<script>

function myLoadFunction() {  
  log("Please click on the 'Device scan' to scan");
}

  function search(ele) {    
    if(event.key === 'Enter') {
        //alert(ele.value);
        event.preventDefault();        
        document.getElementById("btnLogin").click();        
    }
}

  </script>
  


<style>
	.button {
        background-color: #4CAF50;
        border: none;
        color: white;
	    /* padding: 15px 32px; */
        height:100px;
        width: 280px;
        /* width:160px; */
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 36px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 8px;
	}
	.textarea_c {
        background-color: white;
        border: none;
        /* color: white; */
        /* padding: 10px 30px; */
        height:  270px;
        width: 273px;
        text-align: left;
        text-decoration: none;
        display: inline-block;
        font-size: 240px;
        margin: 4px 2px;
        cursor: pointer;
        resize: none;
	}
	.textarea1 {
        background-color: white;
        border: none;
        /* color: white; */
        /* padding: 10px 30px; */
        height:  170px;
        width: 273px;
        text-align: left;
        text-decoration: none;
        display: inline-block;
        font-size: 240px;
        margin: 4px 2px;
        cursor: pointer;
        resize: none;
        left:10px;
	} 
  .textarea2 {
        background-color: white;
        border: none;
        /* color: white; */
        /* padding: 10px 30px; */
        height:  170px;
        width:  500px;
        text-align: left;
        text-decoration: none;
        display: inline-block;
        font-size: 240px;
        margin: 4px 2px;
        cursor: pointer;
        resize: none;
        left:10px;
	} 
	</style>


<style>
  .container1{
    display: flex;
  }
  .fixed{
      width: 200px;
  }
  .flex-item{
      flex-grow: 1;
  }
  .blocks_textbox {
    display: inline-block; 
    /* border: solid 2px red;    */
    /* padding: 16px 20px; */
    display: flex;
    align-items: left;
    justify-content: left;
    margin: 0 auto;
    height:50px; 
    width: 100px;
    font-weight: bold;
    font-size:medium;
    color: rgb(0, 0, 0);
    /* font-family: "verdana"; */
    font-size: 4.5em;
    overflow: hidden;
  /*Hide content before animation*/
    /* border-right: .1em solid white; */
  /*Cursor*/
    white-space: nowrap;
  /*Keep text on same line*/
    margin: 0 auto;
  /*Scrolling effect while typing*/
    letter-spacing: .1em;
    animation: typing 3s steps(30, end), blink-caret .75s steps(1, end) infinite alternate;    
  }
  
  .blocks {
    display: inline-block; 
    /* border: solid 2px red;    */
    /* padding: 16px 20px; */
    display: flex;
    align-items: left;
    justify-content: left;
    margin: 0 auto;
    /* height:50px; 
    width: 100px; */
    font-weight: bold;
 
    color: rgb(0, 0, 0);
    /* font-family: "verdana"; */
    font-size: 3.5em;
    overflow: hidden;
  /*Hide content before animation*/
    /* border-right: .1em solid white; */
  /*Cursor*/
    white-space: nowrap;
  /*Keep text on same line*/
    margin: 0 auto;
  /*Scrolling effect while typing*/
    letter-spacing: .1em;
    animation: typing 3s steps(30, end), blink-caret .75s steps(1, end) infinite alternate;    
  }
  .blocks_txtarea {
    display: inline-block; 
    /* border: solid 2px red;    */
    /* padding: 16px 20px; */
    display: flex;
    align-items: left;
    justify-content: left;
    margin: 0 auto;
    /* height:50px; 
    width: 100px; */
    font-weight: bold;
    font-size:medium;
    color: rgb(0, 0, 0);
    /* font-family: "verdana"; */
    font-size: 4.5em;
    overflow: hidden;
  /*Hide content before animation*/
    /* border-right: .1em solid white; */
  /*Cursor*/
    white-space: nowrap;
  /*Keep text on same line*/
    margin: 0 auto;
  /*Scrolling effect while typing*/
    letter-spacing: .1em;
    animation: typing 3s steps(30, end), blink-caret .75s steps(1, end) infinite alternate;    
}
.wrap{
    width:210px;    
}
 
/* Button used to open the contact form - fixed at the bottom of the page */
.open-button {
  background-color: #555;
  color: white;
  padding: 16px 20px;
  border: none;
  cursor: pointer;
  opacity: 0.8;
  position: fixed;
  bottom: 23px;
  right: 28px;
  width: 280px;
}

 /* The popup form - hidden by default */
  .form-popup {
    display: none;
    /* position: fixed; */
    position: relative;    
    right: 0px;
    bottom: 0px;
    top: 0px;
    left: 0px;
    width: 508px;
    max-width: 600px;
    border: 1px solid #03681cd0;
    z-index: 9;
}

 /* Add styles to the form container */
  .form-container {
    max-width: 600px;
    width: 505px;
    padding: 10px;
    background-color: white;
  }
  
  /* Full-width input fields */
  .form-container input[type=text], .form-container input[type=password] {
    width: 100%;
    padding: 15px;
    margin: 5px 0 22px 0;
    border: none;
    background: #f1f1f1;
  }
  
  /* When the inputs get focus, do something */
  .form-container input[type=text]:focus, .form-container input[type=password]:focus {
    background-color: #ddd;
    outline: none;
  }
  
  /* Set a style for the submit/login button */
  .form-container .btn {
    background-color: #04AA6D;
    color: rgb(255, 255, 255);
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    width: 50%;
    margin-bottom:10px;
    opacity: 0.8;    
  }
  
  /* Add a red background color to the cancel button */
  .form-container .cancel {
    background-color: rgb(55, 85, 7);
  }
  
  /* Add some hover effects to buttons */
  .form-container .btn:hover, .open-button:hover {
    opacity: 1;
  }
</style>


<script>
  function openForm() {
    document.getElementById("myForm").style.display = "block";
  }

  function sendLoginCmd() {
    //alert("sendLoginCmd"+'AT+AUTH='+document.getElementById("pswbox").value);
    sendATL('AT+AUTH='+document.getElementById("pswbox").value);
  }
  function closeForm2() {
    document.getElementById('lblpsw').innerHTML ='';
    document.getElementById('lblpsw').style.color = "black";
  }
  
  function closeForm() {
    
    document.getElementById("myForm").style.display = "none";
  }
  </script>



<link href="css/style.css" rel="stylesheet">

<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
<link href="css/element.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Jura" rel="stylesheet">
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="./js/ekko-lightbox.js"></script>





<style>
  table {
    border-collapse: collapse;
    width: 100%;
  }
  
  th, td {
    text-align: left;
    padding: 8px;
  }
  
  tr:nth-child(even) {
    background-color: #D6EEEE;
  }
  </style>
<link rel="icon" type="image/x-icon" href="./img/pulsaricon-rgb64_2.png" /> 
</head>
<!-- <body onload="myLoadFunction()" onbeforeunload="return bleExitPage2()"> -->
<body onload="myLoadFunction()"></body>
<!-- partial:index.partial.html -->
<section class="accordion">
<section id="header">
    <table>
      <tr style="width:100%">
          <td>
              <div class="logo">
                <a href="" style="text-decoration:none;">
                  <img src="./img/pulsarlogo-old.svg"  alt="Logo" onclick="bleExitPage();" style="width:200px;height:80px;border:none;text-decoration:none;color:#eeeeee00;">
                </a>
              </div>
          </td>

          <td>
            <div class="my_text" id="id_title">
              REFLECT
            </div>
          </td>            
          <td>
             <div class="logo1">
              <a href="" style="text-decoration:none;">
                <!-- <img src="./img/dbr16.png"  alt="Logo" style=" width: 90px;;height: 90px;;border:none;text-decoration:none;color:#eeeeee00;">  -->
                <img src="./img/Icon256Reflect.png"  alt="Logo" onclick="bleExit1Page();" style=" width: 160px;;height: 160px;;border:none;text-decoration:none;color:#eeeeee00;"> 
              </a>
            </div>
          </td>
          </tr>
      </table>            
    </section>
    <section class="accordion-tabs">
      <button class="accordion-tab accordion-active" data-actab-group="0" data-actab-id="0" id="id_home">Home</button>
      <button class="accordion-tab" data-actab-group="0" data-actab-id="1" id="id_trace">Trace</button>
    </section>
    <section class="accordion-content">
      <article class="accordion-item accordion-active" data-actab-group="0" data-actab-id="0">
        <h4 class="accordion-item__label"></h4><!-- IMPORTANT : donot remove this tag-->
        <div class="accordion-item__container">
          <table>
            <tr>               
                <td></td><td></td>
                <td></td><td></td>
                <td></td><td></td>                                
                <!-- <td><button type="button" class="button button-style1" onclick="sendATL('AT+AUTH=123321');  button_press = 3">Test-Login</button></td> -->
                <!-- <td><button type="button" class="button button-style1" onclick="openForm();  button_press = 3">Login</button></td> -->
            </tr>                    
          </table>
                    <div class="form-popup" id="myForm">
                      <form action="" class="form-container">
                        <h1>Login</h1>            
                        <!-- <label for="email"><b>Email</b></label>
                        <input type="text" placeholder="Enter Email" name="email" required> -->
                        <label for="psw" id="lblpsw" ><b>Passcode</b></label>
                        <input type="password" placeholder="Enter Passcode" id="pswbox" name="psw" onkeydown="search(this)" required>            
                        <button type="button" id="btnLogin" class="btn" onclick=" closeForm(); sendLoginCmd(); closeForm2();  ">Login</button>
                        <!-- <button type="button" class="btn cancel" onclick="closeForm()">Close</button>  -->
                      </form>
                    </div>                    
                    <table><tr><td></td><td><div></div></td></tr></table>
   
                    <table style="width:70%">

                      <tr>
                        <td><button type="button" class="button button-style1" onclick="ble_connect(); button_press = 1">Device Scan</button></td>
                        <td><button type="button" class="button button-style1" onclick="bleDisconnect();  button_press = 2">End Session</button></td>
                      </tr>
  
                      <tr>
                        <td>
                          <textarea id="log" class="textarea_c" rows="8" cols="10" style="font-size: 16pt; font-weight: bold; width:450px; height:430px;" readonly></textarea>
                        </td>
                        <td>
              <table style="width:50%">
              <tr>
                            <td>
                          <div  class = "blocks" id='lvl'></div>
                          <div  class = "blocks" id='dist'></div>
                          <div class = "blocks" id='sensor_status'></div>
                              </td>
                              </tr>
                              <tr>
                              <td>
                                <textarea id="data-log" class="textarea2" rows="8" cols="8" style="font-size: 22pt; font-weight: bold; width:380px; height:180px;" readonly></textarea>
                              </td>
                              </tr>
                          </table>
                        </td>
  
  </table>

                  
                  <table><tr><td></td><td><div></div></td></tr></table>
                  <table style="width:66%">
                  <tr>
                    <td><input type="text" id="cmd" style="font-size: 40pt; font-weight: bold; width:580px; height:80px;" onkeydown="wasEnter(this)"></td>
 
                    <td>
                        <button type="button" class="button" onclick="send_command();">
                            SEND
                        </button>
                      </td>
                    <td> 
                    </td>
                  </tr>                      
                  </table>
                  <table style="width:52%;">
                    <tr>
                      <table style="width:30%;">
                        <td style="position: center;">
                          <button type="button" class="button button-style1" id="btn_trace" onclick="trace_off(); button_press=3;">TRACE OFF</button>
                        </td>
                        <td style="position: center;">
                          <button type="center" class="button button-style1" onclick="Normal_mode(); button_press = 13">NORMAL MODE</button>
                        </td>
                        <td>
                          <button type="button" class="button" onclick="clearlog(); button_press = 9">
                            CLEAR
                        </button>
                      </td>
                      </table>
                      
                    </tr>                    
                  </table>
          </div>
      </article>
      <article class="accordion-item" data-actab-group="0" data-actab-id="1">
        <h4 class="accordion-item__label"> </h4> <!-- IMPORTANT : donot remove this tag-->
        <div class="accordion-item__container">
          <table>
            <tr>               
                <td></td><td></td>
                <td></td><td></td>
                <td></td><td></td>                                
                 <!-- <td><button type="button" class="button button-style1" onclick="sendATL('AT+AUTH=123321');  button_press = 3">Test-Login</button></td> -->
            </tr>                    
          </table>

          <!-- <p>reprehenderit temporibus, assumenda cupiditate consequatur soluta odit ex repudiandae delectus cumque, provident hic sed quod? Quis, nam. Similique eaque quae vel recusandae expedita qui sint fugiat, nisi assumenda et ex molestiae atque deleniti magni, ipsam libero!</p> -->
           <!-- start of trace box --> 
           <table style="width:66%"> <!-- check here: start of the trace box -->
            <tr>
              <td>
                <div class="chartBox" style="position: left; margin: auto; height:100%; width:100%">
                    <canvas id="myChart"></canvas>
                </div>  
              </td>                 
                <!-- Offline mode -->
                <script src="./js/chart.js"></script>
                <script>
                // X points/labels
                var xdata = [];
                var pts = 0.50;//0.036;//7.2/200;
                xdata[0] = 0.00;
                for (let i = 1; i <= 200; i++) {
                    xdata[i] = Math.round((xdata[i - 1] + 0.036)*1000)/1000;
                }

                // Echo variables
                var echo = [];

                // Datem variables
                var datem = [];
                for (let i = 0; i < 200; i++) {
                    echo[i] = 0;
                    datem[i] = 0;
                }
                // setup block
                var data = {
                    labels: xdata,            
                    datasets: [{
                        type: 'line',
                        label: 'Datem',   // Datem array
                        data: datem,
                        radius: 1,
                        pointRadius: 1,
                        borderWidth: 2,
                        backgroundColor: 'rgba(75, 119, 190, 1)',
                        borderColor:     'rgba(75, 119, 190, 1)'
                    },
                    {
                        type: 'line',
                        label: 'Echo',    // Echo array
                        data: echo,
                        radius: 1,
                        pointRadius: 1,
                        borderWidth: 2,
                        backgroundColor: 'rgba(255, 0, 0, 1)',
                        borderColor:     'rgba(255, 0, 0, 1)'
                    },
                    ]
                };
                
                // arbitraryLine Plugin
                var arbitraryLine = {       // Fills near & far blanking areas, Plots Distance, gate start and stop. Shows dynamic variables
                    id: 'arbitraryLine',
                    beforeDraw(chart, args, options) {
                        const ctx = chart.canvas.getContext('2d');
                        var { ctr, chartArea: {top, right, bottom, left, width, height}, scales:
                            {x, y} } = chart;
                        ctx.save();
                        ctx.fillStyle = 'yellow';
                        ctx.fillRect(x.getPixelForValue(0), top, near_blanking_var*width/compensated_var, height); // Near blanking area (x.getPixelForValue(0), top, 0.3*width/7.2, height)
                        ctx.fillStyle = 'yellow';
                        ctx.fillRect(x.getPixelForValue((200.0/1.2)*empty_distance/mode_var), top, width*(far_blanking_dist - empty_distance)/compensated_var, height); // Far blanking area
                        ctx.strokeStyle = 'red';
                        ctx.strokeRect(x.getPixelForValue(distance_var*200/compensated_var), top, 0, height);  // Distance//(x0, y0, x1, y1); (x.getPixelForValue(distance_var*200/7.2), top, 0, height)
                        ctx.strokeStyle = 'black';
                        ctx.strokeRect(x.getPixelForValue(gate_start/5), top, 0, height);  // Gate start (x.getPixelForValue((distance_var - 0.20)*200/7.2), top, 0, height)
                        ctx.strokeStyle = 'black';
                        ctx.strokeRect(x.getPixelForValue(gate_stop/5), top, 0, height);  // Gate stop (x.getPixelForValue((distance_var + 0.20)*200/7.2), top, 0, height)
                        ctx.fillStyle = 'black';
                        data_log_update();                  
                        // ctx.fillText("Length          = " + length_var.toFixed(3) + " m", x.getPixelForValue(140), top+10); // Dynamic variables
                        // ctx.fillText("Distance       = " + distance_var.toFixed(3) + " m", x.getPixelForValue(140), top+20);
                        // ctx.fillText("Volume         = " + volume_var.toFixed(3) + " m³", x.getPixelForValue(140), top+30);
                        // ctx.fillText("Temperature = " + temperature_var.toFixed(2) + " °C", x.getPixelForValue(140), top+40);
                        // ctx.fillText("Noise            = " + noise_var.toFixed(0) + " mV", x.getPixelForValue(140), top+50);
                        // ctx.fillText("Output          = " + mA_output_var.toFixed(2) + " mA", x.getPixelForValue(140), top+60);
                        // bit0 = status_var & 1;
                        // bit1 = status_var & 2;
                        // bit2 = status_var & 4;
                        // bit3 = status_var & 8;
                        // bit4 = status_var & 16;
                        // bit5 = status_var & 32;
                        // bit6 = status_var & 64;
                        // bit7 = status_var & 128;
                        // if(status_var == 0)
                        //     ctx.fillText("Status           = OK", x.getPixelForValue(140), top+80);
                        // else
                        // {
                        // if (bit4 == 16)
                        // {
                        //     if (bit5 == 32)
                        //         ctx.fillText("Status           = LOE fail high", x.getPixelForValue(140), top+80);
                        //     else if (bit6 == 64)
                        //         ctx.fillText("Status           = LOE fail low", x.getPixelForValue(140), top+80);
                        //     else
                        //         ctx.fillText("Status           = LOE fail", x.getPixelForValue(140), top+80);
                        // }
                        // else if (bit3 == 8)
                        //     ctx.fillText("Status           = LOE", x.getPixelForValue(140), top+80);
                        // else if (bit2 == 4)
                        //     ctx.fillText("Status           = Temp", x.getPixelForValue(140), top+80);
                        // else if (bit1 == 2)
                        //     ctx.fillText("Status           = Voltage", x.getPixelForValue(140), top+80);
                        // else if (bit7 == 128)
                        //     ctx.fillText("Status           = Alarm", x.getPixelForValue(140), top+80);
                        // else
                        //     ctx.fillText("Status           = " + status_var, x.getPixelForValue(140), top+80);
                        // }
                        ctx.restore();
                    }
                }

                const plugin = {          // For white background plot
                    id: 'custom_canvas_background_color',
                    beforeDraw: (chart) => {
                        const ctx = chart.canvas.getContext('2d');
                        ctx.save();
                        ctx.globalCompositeOperation = 'destination-over';
                        ctx.fillStyle = 'White';//'Transparent';
                        ctx.fillRect(0, 0, chart.width, chart.height);
                        ctx.restore();
                    }
                };
                
                var valtest = Math.round(0.5*200/7.2);
                var rounding;

                // config block
                var config = {
                    type: 'line',
                    data: data,
                    plugins: [plugin, arbitraryLine], // Uses both plugins
                    options: {
                    maintainAspectRatio: false,                                      
                    scales: {                                 
                        x: {
                            //type: 'linear',
                            title: {
                                display: true,
                                text: 'mtrs',
                            },
                            grid: {                
                            },
                            ticks: {
                                maxTicksLimit: xdata.length,
                                // For a category axis, the val is the index so the lookup via getLabelForValue is needed
                                callback: function(val, index) {
                                // Hide the label of every 14th dataset
                                rounding = Math.round(this.getLabelForValue(val)*2)/2;                // Rounded precision
                                if(index == 0)
                                    return (index) % valtest === 0 ? rounding.toFixed(2) : undefined;
                                else          
                                    return (index + 1) % valtest === 0 ? rounding.toFixed(2) : undefined; // Shows rounded value in Xaxis aling with gridline,
                                },                                                                      // undefined don't shows gridlines
                                maxRotation: 0,   // Rotate the tick labels to show horizontally                     
                            }                     
                        },                                       
                        y: {
                            title: {
                                display: true,
                                text: 'mV',
                            },                        
                            max: 1000,
                            min:0,
                            ticks: {
                                stepSize: 100
                            },
                            beginAtZero: true
                        },               
                    },                
                    }                          
                };
                
                // render / init block
                var myChart = new Chart(
                    document.getElementById('myChart'),
                    config
                );
                </script>
            </tr>
            
            <!-- <tr>
                <td>
                    <button type="button" class="button" onclick="sendAT('ATrI'); button_press = 4">
                        Version
                    </button>
                </td>
                <td></td>
                 <td>
                    <button type="button" class="button" onclick="sendAT('AT+PT=1'); button_press = 5">
                        Enter PT
                    </button>
                </td>  
                  <td>
                    <button type="button" class="button" onclick="sendAT('GET ECHO'); button_press = 10">
                        GET ECHO
                    </button>
                </td>               
            </tr> -->          
    </table>
           <!-- end of the trace box-->
        </div>

        <table style="width:60%">
          <tr>              
              <td>
                <div class = "blocks" id='lvl_t'> </div>
                <div class = "blocks" id='dist_t'> </div>
                <div class = "blocks" id='sensor_status_t'> </div>          
              </td>
              <td>
                <textarea id="data-log_t" class="textarea2" rows="4" cols="1" style="font-size: 22pt; font-weight: bold" readonly>data-log_t</textarea>                
              </td>
          </tr>
        </table>
      </article>
    </section>
    <div>
      <table>
        <tr>
          <td style=" text-align:center;  background-color:#656db3;;color:#2e2323;">
            <p style="width: 874px; text-align:center;font-size:16px;  font-weight: bold; color:#ffffff;  line-height:40px;">&copy; Pulsar Measurement 2022<br></p>
          </td>
        </tr>
      </table>
    </div>
  </section>
  <script  src="js/script-lr2.js"></script>
</body>
</html>
